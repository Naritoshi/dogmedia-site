function main() {
  const props = PropertiesService.getScriptProperties();
  const folderId = props.getProperty('FOLDER_ID');
  
  if (!folderId) {
    Logger.log('âŒ FOLDER_ID ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    return;
  }

  const folder = DriveApp.getFolderById(folderId);
  const files = folder.getFiles();
  
  while (files.hasNext()) {
    const file = files.next();
    const mimeType = file.getMimeType();
    
    // JPEG/PNGä»¥å¤–ã€ã¾ãŸã¯å‡¦ç†æ¸ˆã¿(âœ…)ã¯ã‚¹ã‚­ãƒƒãƒ—
    if ((mimeType !== MimeType.JPEG && mimeType !== MimeType.PNG) || file.getName().startsWith('âœ…')) {
      continue;
    }

    Logger.log(`ğŸš€ å‡¦ç†é–‹å§‹: ${file.getName()}`);

    try {
      processImage(file, props);
      file.setName(`âœ…_${file.getName()}`); // å‡¦ç†æ¸ˆã¿ã«ãƒªãƒãƒ¼ãƒ 
      Logger.log('âœ… å®Œäº†');
      return; // PoCç”¨: 1å›1æšã§çµ‚äº†
    } catch (e) {
      Logger.log(`âŒ ã‚¨ãƒ©ãƒ¼: ${e.toString()}`);
    }
  }
}

function processImage(file, props) {
  const apiKey = props.getProperty('GEMINI_API_KEY');
  const githubToken = props.getProperty('GITHUB_TOKEN');
  const repo = props.getProperty('GITHUB_REPO');

  const blob = file.getBlob();
  const base64Image = Utilities.base64Encode(blob.getBytes());
  const mimeType = file.getMimeType();
  const fileName = file.getName();
  // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å®‰å…¨ãªæ–‡å­—ã®ã¿ã«å¤‰æ› (ä¾‹: photo.jpg)
  const safeName = fileName.replace(/[^a-zA-Z0-9._-]/g, '');

  // --- 1. ç”»åƒã‚’ GitHub (static/images/) ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ---
  // Hugo ã§ã¯ static ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸­èº«ãŒãƒ«ãƒ¼ãƒˆã«å…¬é–‹ã•ã‚Œã¾ã™
  const imagePath = `static/images/${safeName}`;
  uploadToGithub(repo, imagePath, base64Image, `ğŸ“¸ Add image: ${fileName}`, githubToken);
  Logger.log(`ğŸ“¤ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†: ${imagePath}`);

  // --- 2. Gemini ã§è¨˜äº‹ç”Ÿæˆ ---
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
  const prompt = `
    ã“ã®ç”»åƒã‚’ãƒ–ãƒ­ã‚°è¨˜äº‹ç”¨ã«åˆ†æã—ã€ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
    Markdownã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¯ä¸è¦ã§ã™ã€‚
    {
      "title": "è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«(30æ–‡å­—ä»¥å†…)",
      "tags": ["ã‚¿ã‚°1", "ã‚¿ã‚°2"],
      "content": "Markdownå½¢å¼ã®æœ¬æ–‡ã€‚æ–½è¨­ã®é›°å›²æ°—ã‚„çŠ¬ã¸ã®å¯¾å¿œãªã©ã‚’è¨˜è¿°ã€‚"
    }
  `;

  const payload = {
    contents: [{
      parts: [
        { text: prompt },
        { inline_data: { mime_type: mimeType, data: base64Image } }
      ]
    }]
  };

  const response = UrlFetchApp.fetch(apiUrl, {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  });

  if (response.getResponseCode() !== 200) {
    throw new Error(`Gemini API Error: ${response.getContentText()}`);
  }

  let rawText = JSON.parse(response.getContentText()).candidates[0].content.parts[0].text;
  rawText = rawText.replace(/```json|```/g, '').trim();
  const data = JSON.parse(rawText);

  // --- 3. Markdown ç”Ÿæˆ (ç”»åƒãƒªãƒ³ã‚¯ä»˜ã) ---
  // static/images/xxx.jpg ã«ç½®ã„ãŸç”»åƒã¯ã€è¨˜äº‹ã‹ã‚‰ã¯ /images/xxx.jpg ã§å‚ç…§ã§ãã¾ã™
  const markdownContent = `---
title: "${data.title}"
date: ${new Date().toISOString()}
cover:
  image: "images/${safeName}"
tags: [${data.tags.map(t => `"${t}"`).join(', ')}]
aiGenerated: true
---

!${data.title}

${data.content}

---
*Generated by Gemini*
`;

  // --- 4. è¨˜äº‹ã‚’ GitHub (content/posts/) ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ---
  const postPath = `content/posts/${Date.now()}-${safeName.split('.')[0]}.md`;
  const base64Markdown = Utilities.base64Encode(markdownContent, Utilities.Charset.UTF_8);
  
  uploadToGithub(repo, postPath, base64Markdown, `ğŸ¤– AI generated: ${data.title}`, githubToken);
  Logger.log(`ğŸ“¤ è¨˜äº‹ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†: ${postPath}`);
}

// GitHub API ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨å…±é€šé–¢æ•°
function uploadToGithub(repo, path, contentBase64, message, token) {
  const url = `https://api.github.com/repos/${repo}/contents/${path}`;
  
  // åŒåãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆä¸Šæ›¸ãç”¨ï¼‰
  let sha = null;
  try {
    const check = UrlFetchApp.fetch(url, {
      method: 'get',
      headers: { 'Authorization': `Bearer ${token}` },
      muteHttpExceptions: true
    });
    if (check.getResponseCode() === 200) {
      sha = JSON.parse(check.getContentText()).sha;
    }
  } catch (e) {}

  const payload = {
    message: message,
    content: contentBase64
  };
  if (sha) {
    payload.sha = sha;
  }

  const response = UrlFetchApp.fetch(url, {
    method: 'put',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Accept': 'application/vnd.github.v3+json'
    },
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  });

  if (response.getResponseCode() !== 201 && response.getResponseCode() !== 200) {
    throw new Error(`GitHub API Error: ${response.getContentText()}`);
  }
}
